name: CI - Tests por clase

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        class_dir:
          # Módulo 2 - Ingeniería y Arquitectura (4 clases implementadas)
          - "Modulo 2 – Ingeniería y Arquitectura/Clase 2 - Principios SOLID y paradigmas de programacion"
          # - "Modulo 2 – Ingeniería y Arquitectura/Clase 3 - Arquitectura limpia"  # TODO: Implementar clase
          - "Modulo 2 – Ingeniería y Arquitectura/Clase 4 - Open_Closed y Dependency Inversion"
          - "Modulo 2 – Ingeniería y Arquitectura/Clase 5 - Integracion y pruebas de arquitectura"
          - "Modulo 2 – Ingeniería y Arquitectura/Clase 6 - Integracion continua y control de calidad"
          # Módulo 3 - Calidad y Seguridad (7 clases)
          - "Modulo 3 – Calidad y Seguridad/Clase 1 - El codigo que se defiende solo"
          - "Modulo 3 – Calidad y Seguridad/Clase 2 - Seguridad básica en tu API"
          - "Modulo 3 – Calidad y Seguridad/Clase 3 - Auditoria continua y defensa inteligente con IA"
          - "Modulo 3 – Calidad y Seguridad/Clase 4 - Seguridad avanzada y autenticación con JWT"
          - "Modulo 3 – Calidad y Seguridad/Clase 5 – Defensa activa y pipelines seguros"
          - "Modulo 3 – Calidad y Seguridad/Clase 6 – Defensa completa y CICD inteligente"
          - "Modulo 3 – Calidad y Seguridad/Clase 7 - Clase Bonus – Observabilidad y alertas con Sentry"
          # Módulo 4 - Infraestructura y Cloud (2 clases implementadas)
          # - "Modulo 4 - Infraestructura y Cloud/Clase 1 - Del código local al entorno vivo"  # TODO: Implementar tests
          - "Modulo 4 - Infraestructura y Cloud/Clase 2 - Tu API en un contenedor"
          - "Modulo 4 - Infraestructura y Cloud/Clase 3 - Base de Datos con SQLAlchemy"
          # - "Modulo 4 - Infraestructura y Cloud/Clase 4 - Migraciones con Alembic"  # TODO: Implementar clase
          # - "Modulo 4 - Infraestructura y Cloud/Clase 5 - Deploy en Cloud Railway y Render"  # TODO: Implementar tests
          # - "Modulo 4 - Infraestructura y Cloud/Clase 6.7 - Writing Tools for AI Agents"  # TODO: Implementar tests
          # - "Modulo 4 - Infraestructura y Cloud/Clase 8 - Proyecto Final"  # TODO: Implementar tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pytest (tests)
        working-directory: ${{ matrix.class_dir }}
        run: |
          # Opcional: limpiar cachés por si vinieran del repo
          find . -type d -name "__pycache__" -exec rm -rf {} +
          find . -type f -name "*.pyc" -delete
          # Retry flaky tests up to 2 times
          pytest -q --reruns 2 --reruns-delay 1
