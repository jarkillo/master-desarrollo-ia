#!/bin/bash
# Pre-push hook para validar cÃ³digo antes de push
# Ejecuta: ruff linting, pytest con coverage >= 80%, validaciÃ³n de secretos
# Para saltar este hook: git push --no-verify

set -e  # Exit on first error

echo "ðŸ” Pre-push hook: Validando cÃ³digo antes de push..."
echo ""

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# FunciÃ³n para imprimir errores
print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# FunciÃ³n para imprimir Ã©xito
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# FunciÃ³n para imprimir warnings
print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# 1. Verificar que estamos en el directorio raÃ­z del repo
if [ ! -d ".git" ]; then
    print_error "No estÃ¡s en el directorio raÃ­z del repositorio"
    exit 1
fi

# 2. Verificar que estamos en un entorno virtual (warning, no bloqueante)
echo "ðŸ” Verificando entorno virtual..."
if [[ -z "$VIRTUAL_ENV" ]]; then
    print_warning "No estÃ¡s en un entorno virtual activado"
    print_warning "Recomendado: activa tu .venv antes de hacer push"
    echo ""
fi

# 3. Ejecutar Ruff linting
echo "ðŸ” Ejecutando Ruff linting..."
if command -v ruff &> /dev/null; then
    if ruff check . --quiet --exclude "**/tareas_bugs.py" --exclude "**/tareas_bugs*.py"; then
        print_success "Ruff linting pasado"
    else
        print_error "Ruff linting fallÃ³"
        echo ""
        echo "ðŸ’¡ Para ver los errores en detalle: ruff check ."
        echo "ðŸ’¡ Para auto-corregir algunos errores: ruff check . --fix"
        echo ""
        echo "Para saltar este hook (NO RECOMENDADO): git push --no-verify"
        exit 1
    fi
else
    print_warning "Ruff no estÃ¡ instalado, saltando linting"
    echo "ðŸ’¡ Instala con: pip install ruff"
fi
echo ""

# 4. Ejecutar tests con coverage
echo "ðŸ” Ejecutando tests con coverage (mÃ­nimo 80%)..."
if command -v pytest &> /dev/null; then
    # Detectar directorios con tests
    test_dirs=()

    # Buscar directorios con tests en las clases mÃ¡s recientes
    if [[ -d "Modulo 4 - Infraestructura y Cloud/Clase 2 - Tu API en un contenedor/tests" ]]; then
        test_dirs+=("Modulo 4 - Infraestructura y Cloud/Clase 2 - Tu API en un contenedor")
    fi
    if [[ -d "Modulo 3 - Seguridad y Buenas Practicas/Clase 7 - Monitoreo con Sentry/tests" ]]; then
        test_dirs+=("Modulo 3 - Seguridad y Buenas Practicas/Clase 7 - Monitoreo con Sentry")
    fi

    if [[ ${#test_dirs[@]} -eq 0 ]]; then
        print_warning "No se encontraron directorios de tests conocidos"
    else
        for dir in "${test_dirs[@]}"; do
            echo "  ðŸ“‚ Testing: $dir"
            cd "$dir"

            # Limpiar cachÃ©s
            find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true

            if pytest --cov=api --cov-report=term-missing --cov-fail-under=80 -q; then
                print_success "Tests pasados con coverage >= 80%: $dir"
            else
                cd - > /dev/null
                print_error "Tests fallaron o coverage < 80%: $dir"
                echo ""
                echo "ðŸ’¡ Para ver detalles: cd '$dir' && pytest -v"
                echo "ðŸ’¡ Para ver coverage: cd '$dir' && pytest --cov=api --cov-report=html"
                echo ""
                echo "Para saltar este hook (NO RECOMENDADO): git push --no-verify"
                exit 1
            fi
            cd - > /dev/null
        done
    fi
else
    print_warning "Pytest no estÃ¡ instalado, saltando tests"
    echo "ðŸ’¡ Instala con: pip install pytest pytest-cov"
fi
echo ""

# 5. ValidaciÃ³n de secretos (gitleaks)
echo "ðŸ” Buscando secretos en el cÃ³digo (gitleaks)..."

# Buscar gitleaks en PATH y en ubicaciÃ³n de Scoop (Windows)
GITLEAKS_CMD=""
if command -v gitleaks &> /dev/null; then
    GITLEAKS_CMD="gitleaks"
elif [[ -f "$HOME/scoop/shims/gitleaks.exe" ]]; then
    GITLEAKS_CMD="$HOME/scoop/shims/gitleaks.exe"
elif [[ -f "/c/Users/$USER/scoop/shims/gitleaks.exe" ]]; then
    GITLEAKS_CMD="/c/Users/$USER/scoop/shims/gitleaks.exe"
fi

if [[ -n "$GITLEAKS_CMD" ]]; then
    # Use .gitleaks.toml if it exists, otherwise use default config
    GITLEAKS_CONFIG=""
    if [[ -f ".gitleaks.toml" ]]; then
        GITLEAKS_CONFIG="--config .gitleaks.toml"
    fi

    if $GITLEAKS_CMD detect --source . $GITLEAKS_CONFIG --no-banner --redact 2>&1 | grep -q "no leaks found"; then
        print_success "No se encontraron secretos"
    else
        print_error "Â¡SECRETOS DETECTADOS EN EL CÃ“DIGO!"
        echo ""
        echo "ðŸ’¡ Revisa los archivos marcados por gitleaks"
        echo "ðŸ’¡ Si son falsos positivos, agrÃ©galos a .gitleaksignore"
        echo "ðŸ’¡ NO hagas commit de API keys, tokens, contraseÃ±as reales"
        echo ""
        echo "Para ver detalles: $GITLEAKS_CMD detect --source . --verbose"
        echo ""
        echo "Para saltar este hook (PELIGROSO): git push --no-verify"
        exit 1
    fi
else
    print_warning "Gitleaks no estÃ¡ instalado, saltando validaciÃ³n de secretos"
    echo "ðŸ’¡ Instala con: scoop install gitleaks"
    echo "ðŸ’¡ O descarga desde: https://github.com/gitleaks/gitleaks"
fi
echo ""

# 6. Todo OK
print_success "Pre-push hook completado exitosamente"
echo ""
echo "âœ¨ Tu cÃ³digo estÃ¡ listo para push"
echo ""

exit 0
